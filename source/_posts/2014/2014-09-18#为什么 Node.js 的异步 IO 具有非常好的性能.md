---
title: 为什么 Node.js 的异步 IO 具有非常好的性能
alias: '1843'
tags:
  - Node.js
date: 2014-09-18
---

Node.js 的卖点是「异步单线程」，虽然主流 Web 后端编程语言中，对异步编程有很好支持的语言并不少，但只有 Node.js 丧心病狂地将所有 IO 强制异步进行。Python 和 Ruby 也有这样的框架，但因为在实际使用中会不可避免地用到含有同步代码的库，因此没能成长起来，而在 Node.js 之前，JavaScript 的服务器端编程几乎是空白，所以 Node.js 才得以建立起了一个所有 IO 均为异步的代码库。

大部分 Web 应用的瓶颈都在 IO, 即读写磁盘，读写网络，读写数据库。使用怎样的策略等待这段时间，就成了改善性能的关键点。

*   PHP 的策略：多进程运行，直接原地等待 IO 完成。缺点：多个进程会消耗多份内存，进程间难以共享数据。
*   C/C++ 通常的策略：多线程运行，程序自己维护锁的状态。缺点：开发成本高，容易出错，不易调试。
*   Python(Tornado): 多个请求在单个进程中轮流执行，遇到 IO 时切换到另一个请求。缺点：对于单个请求而言，依然没有最高效地利用时间。

何谓「最高效地利用时间」？比如现在有两个不相关的数据库查询，在 PHP 中通常会先执行一个，执行完成后再执行第二个(总时间是 a + b). 显然这不是最高效的，应该同时执行两个查询，时间是 max(a, b).

Python 和其他支持多线程的语言的问题就在于，在语言层面，程序员很难告诉虚拟机，应当将两个操作同时执行，即使有办法，也相当麻烦，大多数人懒得去用(也不值得去用)。而因为 Node.js 丧心病狂地强制所有 IO 异步执行，Node.js 的程序员也可以说是轻车熟路，配合一些改善代码可读性库(promise, async), 可以很轻松地让不相干的操作并行执行。

上面讲了异步 IO 的实现，那么异步 IO 的优势究竟体现在哪里呢。实际上异步 IO 并不能神奇地减轻服务器的压力，该加服务器还是一样要加服务器，只不过异步 IO 会减少单个请求的时间，去掉单个请求中那些无意义的等待时间。所以单位时间内处理的请求没有变化，但每个请求的处理时间却减少了。从这个角度，服务器也节约了一些资源——即维持每个请求的连接消耗的内存。
